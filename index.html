<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Taxon Range QuickStatements Generator (Batch Mode)</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        label { display: block; margin-top: 1em; }
        input[type="text"], input[type="number"] { width: 300px; }
        textarea { width: 100%; height: 300px; margin-top: 1em; }
        #loading { font-weight: bold; color: red; margin-top: 1em; display: none; }
    </style>
</head>
<body>
    <h1>Taxon Range QuickStatements Generator (Batch Mode)</h1>
    <p>Enter parameters and click "Generate QuickStatements".</p>
    <form id="qsForm">
        <label>
            Enter region name (continent or country, e.g., <strong>Africa</strong> or <strong>Chile</strong>):
            <input type="text" id="regionName" value="Africa">
        </label>
        <label>
            Upper taxonKey (default <strong>212</strong> for birds):
            <input type="number" id="upperTaxonKey" value="212">
        </label>
        <label>
            Minimum count (default <strong>10</strong>):
            <input type="number" id="minCount" value="10">
        </label>
        <button type="submit">Generate QuickStatements</button>
    </form>
    <div id="loading">Loading... please wait</div>
    <textarea id="output" placeholder="QuickStatements output will appear here..."></textarea>
    <script>
        async function fetchRegionInfo(regionName) {
            const sparqlQuery = `
                SELECT ?region ?regionLabel ?isoCode WHERE {
                    { ?region wdt:P31 wd:Q5107. } UNION { ?region wdt:P31 wd:Q6256. }
                    ?region rdfs:label ?regionLabel.
                    FILTER(LANG(?regionLabel) = "en").
                    OPTIONAL { ?region wdt:P297 ?isoCode. }
                    FILTER(STR(?regionLabel) = "${regionName}")
                } LIMIT 1`;
            const url = `https://query.wikidata.org/sparql?format=json&query=${encodeURIComponent(sparqlQuery)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results.bindings.length === 0) return null;
                return data.results.bindings[0];
            } catch (error) {
                console.error("Error fetching region info from Wikidata:", error);
                return null;
            }
        }

        // Add chunking function
        function chunkArray(arr, size) {
            const chunks = [];
            for (let i = 0; i < arr.length; i += size) {
                chunks.push(arr.slice(i, i + size));
            }
            return chunks;
        }

        // Modified Wikidata QID fetcher with chunking
        async function fetchWikidataQIDs(gbifKeys) {
            const chunkSize = 300; // Wikidata can handle ~300 keys per query
            const chunks = chunkArray(gbifKeys, chunkSize);
            const mapping = {};

            for (const chunk of chunks) {
                const valuesClause = chunk.map(key => `"${key}"`).join(" ");
                const sparqlQuery = `
                    SELECT ?taxon ?gbifKey WHERE {
                        VALUES ?gbifKey { ${valuesClause} }
                        ?taxon wdt:P846 ?gbifKey.
                    }`;
                
                try {
                    const sparqlURL = `https://query.wikidata.org/sparql?format=json&query=${encodeURIComponent(sparqlQuery)}`;
                    const response = await fetch(sparqlURL);
                    const data = await response.json();
                    data.results.bindings.forEach(binding => {
                        const qid = binding.taxon.value.split("/").pop();
                        const gbifKey = binding.gbifKey.value;
                        mapping[gbifKey] = qid;
                    });
                } catch (error) {
                    console.error("Error fetching chunk:", error);
                }
            }
            return mapping;
        }

        document.getElementById("qsForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            document.getElementById("loading").style.display = "block";
            document.getElementById("output").value = "";
            
            const regionName = document.getElementById("regionName").value.trim();
            const upperTaxonKey = document.getElementById("upperTaxonKey").value.trim();
            const minCount = document.getElementById("minCount").value.trim();
            
            const regionInfo = await fetchRegionInfo(regionName);
            if (!regionInfo) {
                alert("Region not found in Wikidata.");
                document.getElementById("loading").style.display = "none";
                return;
            }
            
            const regionQID = regionInfo.region.value.split("/").pop();
            const isoCode = regionInfo.isoCode ? regionInfo.isoCode.value : null;
            const isCountry = isoCode !== null;
            
            let gbifURL = `https://api.gbif.org/v1/occurrence/search?taxonKey=${upperTaxonKey}&limit=0&facet=speciesKey&facetMincount=${minCount}&facetLimit=5000`;
            gbifURL += isCountry ? `&country=${isoCode}` : `&continent=${encodeURIComponent(regionName)}`;
            
            try {
                const response = await fetch(gbifURL);
                const gbifData = await response.json();
                const counts = gbifData.facets?.[0]?.counts || [];
                if (counts.length === 0) {
                    alert("No species found meeting the criteria.");
                    document.getElementById("loading").style.display = "none";
                    return;
                }
                
                const gbifKeys = counts.map(item => item.name);
                const qidMapping = await fetchWikidataQIDs(gbifKeys);
                
                let qsLines = gbifKeys.map(key => {
                    const wikidataQID = qidMapping[key] || "Q???";
                    return `${wikidataQID}\tP9714\t${regionQID}\tS854\t"https://www.gbif.org/species/${key}"\tS248\tQ1531570`;
                }).join("\n");
                
                document.getElementById("output").value = qsLines;
            } catch (error) {
                alert("Error fetching from GBIF API: " + error);
            }
            
            document.getElementById("loading").style.display = "none";
        });
    </script>
</body>
</html>
